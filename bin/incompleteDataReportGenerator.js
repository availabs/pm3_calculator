#!/usr/bin/env node

/* eslint no-console: 0, camelcase: 0, no-shadow: 0 */

// Reads the data_gaps_log.ndjson file
//   generated by bin/npmrdsMonthDownloadCompletenessChecker.js
//   and generates a human-readable report.

const { split, through } = require('event-stream');

const makeJSONHumanReadable = () => {
  const collector = {};
  return through(
    line => {
      if (!line) {
        return;
      }
      try {
        const { tmc_code, data_gaps } = JSON.parse(line);
        collector[tmc_code] = collector[tmc_code] || [];
        collector[tmc_code].push(...data_gaps);
      } catch (err) {
        console.error(err);
      }
    },

    function end() {
      Object.keys(collector)
        .sort()
        .forEach(tmc_code => {
          console.log(`* ${tmc_code}`);
          collector[tmc_code].forEach(({ datasources, start, end }, i) => {
            const idx = `  ${i + 1}`.slice(-3);
            console.log(`  ${idx})  datasources   ${datasources.join(',')}`);
            console.log(`        start:        ${start}`);
            console.log(`        end:          ${end}`);
          });
        });
      this.emit('end');
    }
  );
};

process.stdin
  .pipe(split())
  .pipe(makeJSONHumanReadable())
  .pipe(process.stdout);
