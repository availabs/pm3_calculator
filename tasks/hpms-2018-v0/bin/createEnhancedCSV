#!/bin/bash

set -e

DIRNAME="$( dirname "${BASH_SOURCE[0]}" )"

FILE1="$1"

## Validate the input file
if [ -z "$FILE1" ]; then
  (>&2 echo "ERROR: Specify the unenhanced input file as the 1st cli argumnent." )
  exit 1
fi

if ! [ -f "$FILE1" ]; then
  (>&2 echo "ERROR: No file found at $FILE1" )
  exit 1
fi

if ! grep -Fq Travel_Time_Code "$FILE1"; then
  (>&2 echo "ERROR: input file does not have a 'Travel_Time_Code' column" )
  exit 1
fi

FILE1_COL_NUMS="$(
  head -1 "$FILE1" |
    tr , '\n' |
    nl |
    awk 'OFS="," { print $1, $2 }'
)"

# Get the column number of the Travel_Time_Code in the input file
FILE1_TMC_COL_NUM="$(
  grep Travel_Time_Code <<< "$FILE1_COL_NUMS" | cut -d, -f1
)"

# Get the column number of the Year in the input file
FILE1_YEAR_COL_NUM="$(
  grep Year_Record <<< "$FILE1_COL_NUMS" | cut -d, -f1
)"

# Get the year from the input file
YEAR="$(
  tail -1 "$FILE1" | cut -d, -f"$FILE1_YEAR_COL_NUM"
)"

# The path to the tmc-2-geos mapping csv
FILE2="${DIRNAME}/lib/tmc2geos_${YEAR}.csv"

FILE2_COL_NUMS="$(
  head -1 "$FILE2" |
    tr , '\n' |
    nl |
    awk 'OFS="," { print $1, $2 }'
)"

# Get the column number of the Travel_Time_Code in the tmc-2-geos mapping csv
FILE2_TMC_COL_NUM="$(
  grep Travel_Time_Code <<< "$FILE2_COL_NUMS" | cut -d, -f1
)"


# The join program move the join column to the first column
#   unless you specify the column order
FILE_1_FIELDS=$(
  cut -d, -f1 <<< "$FILE1_COL_NUMS" |
    sed 's/ //g; s/^/1./g;' |
    tr '\n' ,
)

FILE_2_FIELDS=$(
  sed '/Travel_Time_Code/d' <<< "$FILE2_COL_NUMS" |
    cut -d, -f1 |
    sed 's/ //g; s/^/2./g' |
    tr '\n' , |
    sed 's/,$//'
)

OUTPUT_FORMAT="${FILE_1_FIELDS}${FILE_2_FIELDS}"

# Output the extended CSV
 join --header -t, -o"$OUTPUT_FORMAT" -1"$FILE1_TMC_COL_NUM" -2"$FILE2_TMC_COL_NUM" "$FILE1" "$FILE2"
